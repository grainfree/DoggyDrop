@model DoggyDrop.ViewModels.TrashBinViewModel
@{
    ViewData["Title"] = "Dodaj nov koš";
}

<style>
    #map {
        height: 300px;
        width: 100%;
        margin-bottom: 20px;
    }

    .form-container {
        max-width: 600px;
        margin: 0 auto;
    }

    #loadingOverlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.85);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
</style>

<div class="form-container">
    <h2 class="text-center mb-4">➕ Dodaj nov koš</h2>

    <form asp-action="Add" enctype="multipart/form-data">
        <div class="mb-3">
            <label asp-for="Name" class="form-label">Ime lokacije</label>
            <input asp-for="Name" class="form-control" required />
            <span asp-validation-for="Name" class="text-danger small"></span>
        </div>

        <div id="map"></div>

        <input type="hidden" asp-for="Latitude" id="Latitude" />
        <input type="hidden" asp-for="Longitude" id="Longitude" />

        <div class="mb-3">
            <label asp-for="ImageFile" class="form-label">Fotografija koša</label>
            <input asp-for="ImageFile" class="form-control" type="file" accept="image/*" capture="environment" required />
            <span asp-validation-for="ImageFile" class="text-danger small"></span>
        </div>

        <button type="submit" class="btn btn-success w-100 rounded-pill">📍 Dodaj koš</button>
    </form>
</div>

<!-- Overlay spinner -->
<div id="loadingOverlay" class="d-flex">
    <div class="spinner-border text-success" role="status">
        <span class="visually-hidden">Nalagam...</span>
    </div>
</div>

<!-- Toast obvestilo -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
    <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                ✅ Koš je bil uspešno dodan!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Zapri"></button>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        let map;

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 46.5547, lng: 15.6459 },
                zoom: 15
            });

            let marker;

            map.addListener("click", function (e) {
                const lat = e.latLng.lat();
                const lng = e.latLng.lng();

                document.getElementById("Latitude").value = lat;
                document.getElementById("Longitude").value = lng;

                if (marker) marker.setMap(null);

                marker = new google.maps.Marker({
                    position: e.latLng,
                    map: map
                });
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            const form = document.querySelector("form");

            form.addEventListener("submit", function (e) {
                // Prevent immediate submission
                e.preventDefault();

                // Check form validity manually
                if (form.checkValidity()) {
                    document.getElementById("loadingOverlay").style.display = "flex";
                    form.submit(); // Now safely submit
                } else {
                    form.classList.add("was-validated");
                }
            });
        });
    </script>

    @if (TempData["SuccessMessage"] != null)
    {
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const toastEl = document.getElementById("successToast");
                const toast = new bootstrap.Toast(toastEl);
                toast.show();
            });
        </script>
    }

    <script async
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC7BZuc_0STrDlrpQL6HF3mcQJW2HV4cDI&callback=initMap">
    </script>
}

