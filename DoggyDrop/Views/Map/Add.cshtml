@model DoggyDrop.ViewModels.TrashBinViewModel
@{
    ViewData["Title"] = "Dodaj nov koš";
}

<style>
    #map {
        height: 300px;
        width: 100%;
        margin-bottom: 20px;
    }

    .form-container {
        max-width: 600px;
        margin: 0 auto;
    }

    #loadingOverlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.85);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
</style>

<div class="form-container">
    <h2 class="text-center mb-4">➕ Dodaj nov koš</h2>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success text-center">@TempData["SuccessMessage"]</div>
    }

    <form asp-action="Add" method="post" enctype="multipart/form-data">
        @Html.AntiForgeryToken()

        <div asp-validation-summary="ModelOnly" class="text-danger small mb-2"></div>

        <div class="mb-3">
            <label asp-for="Name" class="form-label">Ime lokacije</label>
            <input asp-for="Name" class="form-control" />
            <span asp-validation-for="Name" class="text-danger small"></span>
        </div>

        <div id="map"></div>

        <input type="hidden" asp-for="Latitude" id="Latitude" />
        <input type="hidden" asp-for="Longitude" id="Longitude" />

        <div class="mb-3">
            <label asp-for="ImageFile" class="form-label">Fotografija koša</label>
            <input asp-for="ImageFile" type="file" accept="image/*" capture="environment" class="form-control" />
            <span asp-validation-for="ImageFile" class="text-danger small"></span>
        </div>

        <button type="submit" class="btn btn-success w-100 rounded-pill">📍 Dodaj koš</button>
    </form>
</div>

<!-- Spinner overlay -->
<div id="loadingOverlay" class="d-flex">
    <div class="spinner-border text-success" role="status">
        <span class="visually-hidden">Nalagam...</span>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        let map, marker;

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 46.5547, lng: 15.6459 },
                zoom: 15
            });

            // Geolokacija uporabnika
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    const userLatLng = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    map.setCenter(userLatLng);
                    marker = new google.maps.Marker({
                        position: userLatLng,
                        map: map
                    });

                    document.getElementById("Latitude").value = userLatLng.lat;
                    document.getElementById("Longitude").value = userLatLng.lng;
                });
            }

            map.addListener("click", function (e) {
                const lat = e.latLng.lat();
                const lng = e.latLng.lng();

                document.getElementById("Latitude").value = lat;
                document.getElementById("Longitude").value = lng;

                if (marker) marker.setMap(null);
                marker = new google.maps.Marker({
                    position: e.latLng,
                    map: map
                });
            });
        }

        // Pokaži spinner samo če je obrazec veljaven
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.querySelector("form");

            form.addEventListener("submit", function (e) {
                if (!form.checkValidity()) {
                    e.preventDefault();
                    e.stopPropagation();
                } else {
                    document.getElementById("loadingOverlay").style.display = "flex";
                }
            });
        });
    </script>

    <script async
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC7BZuc_0STrDlrpQL6HF3mcQJW2HV4cDI&callback=initMap">
    </script>
}
